insert new part
insert new part
insert new part
insert new part
system.parts
all_0_0_0	1	['proj','proj_2']
all_1_1_0	1	['proj','proj_2']
all_2_2_0	1	['proj','proj_2']
all_3_3_0	1	['proj','proj_2']
select from projection 'proj', expect error: 
12
16
used projections
SELECT c FROM test WHERE d == 12 OR d == 16 ORDER BY c;	['test.test.proj']
select from projection 'proj_2', expect error: 
12
16
used projections
SELECT d FROM test WHERE c == 12 OR c == 16 ORDER BY d;	['test.test.proj_2']
check table
1
broke metadata of part 'proj' (parent part: all_2_2_0)
system.parts
all_0_0_0	1	['proj','proj_2']
all_1_1_0	1	['proj','proj_2']
all_2_2_0	1	['proj','proj_2']
all_3_3_0	1	['proj','proj_2']
select from projection 'proj', expect error: 
12
16
used projections
SELECT c FROM test WHERE d == 12 OR d == 16 ORDER BY c;	['test.test.proj']
select from projection 'proj_2', expect error: 
12
16
used projections
SELECT d FROM test WHERE c == 12 OR c == 16 ORDER BY d;	['test.test.proj_2']
check table
0
broken projections info
all_2_2_0	proj	FILE_DOESNT_EXIST
check table full
all_2_2_0	0	Part all_2_2_0 has a broken projections. It will be ignored. Broken projections info: \nCode: 707. DB::Exception: Part all_2_2_0 has a broken projection proj (error: Code: 107. DB::ErrnoException: Cannot open file /var/lib/clickhouse/store/521/521986ec-2fef-42c8-a402-83f937689286/all_2_2_0/proj.proj/columns.txt, errno: 2, strerror: No such file or directory. (FILE_DOESNT_EXIST) (version 23.11.1.1)). (BROKEN_PROJECTION) (version 23.11.1.1)
broke data of part 'proj_2' (parent part: all_2_2_0)
broken projections info
all_2_2_0	proj	FILE_DOESNT_EXIST
system.parts
all_0_0_0	1	['proj','proj_2']
all_1_1_0	1	['proj','proj_2']
all_2_2_0	1	['proj','proj_2']
all_3_3_0	1	['proj','proj_2']
select from projection 'proj', expect error: proj_2
12
16
used projections
SELECT c FROM test WHERE d == 12 OR d == 16 ORDER BY c;	['test.test.proj']
select from projection 'proj_2', expect error: proj_2
check table
0
broken projections info
all_2_2_0	proj	FILE_DOESNT_EXIST
all_2_2_0	proj_2	NO_FILE_IN_DATA_PART
system.parts
all_0_0_0	1	['proj','proj_2']
all_1_1_0	1	['proj','proj_2']
all_2_2_0	1	['proj','proj_2']
all_3_3_0	1	['proj','proj_2']
select from projection 'proj', expect error: 
12
16
used projections
SELECT c FROM test WHERE d == 12 OR d == 16 ORDER BY c;	['test.test.proj']
select from projection 'proj_2', expect error: 
12
16
used projections
SELECT d FROM test WHERE c == 12 OR c == 16 ORDER BY d;	['test.test.proj_2']
check table
0
broke data of part 'proj_2' (parent part: all_3_3_0)
broken projections info
all_2_2_0	proj	FILE_DOESNT_EXIST
all_2_2_0	proj_2	NO_FILE_IN_DATA_PART
insert new part
insert new part
optimize
OPTIMIZE TABLE test SETTINGS alter_sync=0
0
broken projections info
all_2_2_0	proj	FILE_DOESNT_EXIST
all_2_2_0	proj_2	NO_FILE_IN_DATA_PART
all_3_3_0	proj_2	NO_FILE_IN_DATA_PART
system.parts
all_0_0_0	1	['proj','proj_2']
all_1_1_0	1	['proj','proj_2']
all_2_2_0	1	['proj','proj_2']
all_3_3_0	0	['proj','proj_2']
all_3_5_1	1	['proj']
all_4_4_0	0	['proj','proj_2']
all_5_5_0	0	['proj','proj_2']
select from projection 'proj', expect error: 
12
16
used projections
SELECT c FROM test WHERE d == 12 OR d == 16 ORDER BY c;	['test.test.proj']
select from projection 'proj_2', expect error: 
12
16
used projections
SELECT d FROM test WHERE c == 12 OR c == 16 ORDER BY d;	['test.test.proj_2']
check table
0
broke metadata of part 'proj' (parent part: all_1_1_0)
Detach - Attach
broken projections info
all_1_1_0	proj	NO_FILE_IN_DATA_PART
all_2_2_0	proj	NO_FILE_IN_DATA_PART
all_2_2_0	proj_2	FILE_DOESNT_EXIST
all_3_3_0	proj_2	FILE_DOESNT_EXIST
broke data of part 'proj_2' (parent part: all_1_1_0)
Detach - Attach
broken projections info
all_1_1_0	proj	NO_FILE_IN_DATA_PART
all_1_1_0	proj_2	FILE_DOESNT_EXIST
all_2_2_0	proj	NO_FILE_IN_DATA_PART
all_2_2_0	proj_2	FILE_DOESNT_EXIST
all_3_3_0	proj_2	FILE_DOESNT_EXIST
system.parts
all_0_0_0	1	['proj','proj_2']
all_1_1_0	1	['proj','proj_2']
all_2_2_0	1	['proj','proj_2']
all_3_3_0	0	['proj','proj_2']
all_3_5_1	1	['proj']
all_4_4_0	0	['proj','proj_2']
all_5_5_0	0	['proj','proj_2']
select from projection 'proj', expect error: 
12
16
used projections
SELECT c FROM test WHERE d == 12 OR d == 16 ORDER BY c;	['test.test.proj']
select from projection 'proj_2', expect error: 
12
16
used projections
SELECT d FROM test WHERE c == 12 OR c == 16 ORDER BY d;	['test.test.proj_2']
check table
0
check table full
all_2_2_0	0	Part all_2_2_0 has a broken projections. It will be ignored. Broken projections info: \nCode: 707. DB::Exception: Part all_2_2_0 has a broken projection proj (error: Code: 107. DB::ErrnoException: Cannot open file /var/lib/clickhouse/store/521/521986ec-2fef-42c8-a402-83f937689286/all_2_2_0/proj.proj/columns.txt, errno: 2, strerror: No such file or directory. (FILE_DOESNT_EXIST) (version 23.11.1.1))\nPart all_2_2_0 has a broken projection proj_2 (error: Code: 226. DB::Exception: There is no file for column \'c\' in data part \'proj_2\'. (NO_FILE_IN_DATA_PART) (version 23.11.1.1)). (BROKEN_PROJECTION) (version 23.11.1.1)
all_1_1_0	0	Part all_1_1_0 has a broken projections. It will be ignored. Broken projections info: \nCode: 707. DB::Exception: Part all_1_1_0 has a broken projection proj (error: Code: 107. DB::ErrnoException: Cannot open file /var/lib/clickhouse/store/521/521986ec-2fef-42c8-a402-83f937689286/all_1_1_0/proj.proj/columns.txt, errno: 2, strerror: No such file or directory. (FILE_DOESNT_EXIST) (version 23.11.1.1))\nPart all_1_1_0 has a broken projection proj_2 (error: Code: 226. DB::Exception: There is no file for column \'c\' in data part \'proj_2\'. (NO_FILE_IN_DATA_PART) (version 23.11.1.1)). (BROKEN_PROJECTION) (version 23.11.1.1)
materialize projection proj
check table full
system.parts
all_0_0_0	0	['proj','proj_2']
all_0_0_0_6	1	['proj','proj_2']
all_1_1_0	0	['proj','proj_2']
all_1_1_0_6	1	['proj','proj_2']
all_2_2_0	0	['proj','proj_2']
all_2_2_0_6	1	['proj','proj_2']
all_3_3_0	0	['proj','proj_2']
all_3_5_1	0	['proj']
all_3_5_1_6	1	['proj']
all_4_4_0	0	['proj','proj_2']
all_5_5_0	0	['proj','proj_2']
select from projection 'proj', expect error: 
12
16
used projections
SELECT c FROM test WHERE d == 12 OR d == 16 ORDER BY c;	['test.test.proj']
select from projection 'proj_2', expect error: 
12
16
used projections
SELECT d FROM test WHERE c == 12 OR c == 16 ORDER BY d;	['test.test.proj_2']
check table
1
materialize projection proj_2
check table full
broke data of part 'proj' (parent part: all_3_5_1_7)
insert new part
optimize
OPTIMIZE TABLE test FINAL
insert new part
optimize
OPTIMIZE TABLE test FINAL
system.parts
all_0_0_0	0	['proj','proj_2']
all_0_0_0_6	0	['proj','proj_2']
all_0_0_0_7	0	['proj','proj_2']
all_0_8_2_7	1	['proj_2']
all_1_1_0	0	['proj','proj_2']
all_1_1_0_6	0	['proj','proj_2']
all_1_1_0_7	0	['proj','proj_2']
all_2_2_0	0	['proj','proj_2']
all_2_2_0_6	0	['proj','proj_2']
all_2_2_0_7	0	['proj','proj_2']
all_3_3_0	0	['proj','proj_2']
all_3_5_1	0	['proj']
all_3_5_1_6	0	['proj']
all_3_5_1_7	0	['proj','proj_2']
all_4_4_0	0	['proj','proj_2']
all_5_5_0	0	['proj','proj_2']
all_8_8_0	0	['proj','proj_2']
all_9_9_0	1	['proj','proj_2']
select from projection 'proj', expect error: 
12
16
used projections
SELECT c FROM test WHERE d == 12 OR d == 16 ORDER BY c;	['test.test.proj_2']
select from projection 'proj_2', expect error: 
12
16
used projections
SELECT d FROM test WHERE c == 12 OR c == 16 ORDER BY d;	['test.test.proj_2']
check table
1
