#!/usr/bin/env bash
# Tags: no-parallel

CURDIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
# shellcheck source=../shell_config.sh
. "$CURDIR"/../shell_config.sh

QUERY="SELECT finalizeAggregation(CAST(unhex('012A0300000000000000030000000000000043434303000000000000004141410400000000000000414141410100800200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') AS AggregateFunction(approx_top_k(3), Array(Array(String)))))"

out="$( { printf '%s\n' "$QUERY"; } | ${CLICKHOUSE_CLIENT} -n 2>&1 )"
status=$?

if [ "$status" -ne 0 ]; then
  echo "$out"
  exit 1
fi

if echo "$out" | grep -qE '^\s*\[\]\s*$'; then
  echo OK
  echo
  echo
  exit 0
fi

echo "$out"
exit 1


