-- { echo ON }

set allow_experimental_analyzer = 1;
drop table if exists t;
create table t (i int, j int, projection p (select * order by j)) engine MergeTree order by tuple()
settings index_granularity = 1, max_bytes_to_merge_at_max_space_in_pool = 1; -- disable merge
-- The following data is constructed in a way to verifies that query condition
-- cache no longer has key collisions for projection parts
insert into t select 20, number from numbers(10);
insert into t select 1, number + 1 from numbers(10);
system drop query condition cache;
select j from t where j > 3 and i = 20 order by j settings max_threads = 1, use_query_condition_cache = 1, query_condition_cache_store_conditions_as_plaintext = 1;
4
5
6
7
8
9
select part_name, condition from system.query_condition_cache order by condition;
all_1_1_0:p	and(equals(__table1.i, 20_UInt8), greater(__table1.j, 3_UInt8))
all_2_2_0:p	and(equals(__table1.i, 20_UInt8), greater(__table1.j, 3_UInt8))
select j from t where j > 3 and i = 20 order by j settings max_threads = 1, use_query_condition_cache = 1, query_condition_cache_store_conditions_as_plaintext = 1;
4
5
6
7
8
9
drop table t;
