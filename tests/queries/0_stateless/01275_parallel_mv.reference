-- { echoOn }



select 'optimize_trivial_insert_select=0', 'max_insert_threads=0';
optimize_trivial_insert_select=0	max_insert_threads=0
insert into testX select number from numbers(200) settings
    log_queries=1,
    parallel_view_processing=0,
    optimize_trivial_insert_select=0,
    max_insert_threads=0; -- { serverError FUNCTION_THROW_IF_VALUE_IS_NON_ZERO }
system flush logs;
select peak_threads_usage from system.query_log where
    current_database = currentDatabase() and
    type != 'QueryStart' and
    query like '%insert into testX %' and
    Settings['parallel_view_processing'] = '0' and
    Settings['optimize_trivial_insert_select'] = '0' and
    Settings['max_insert_threads'] = '0';
2
select count() from testX;
200
select count() from testXA;
200
select count() from testXB;
0
select count() from testXC;
200
select 'optimize_trivial_insert_select=0', 'max_insert_threads=5';
optimize_trivial_insert_select=0	max_insert_threads=5
insert into testX select number from numbers(200) settings
    log_queries=1,
    parallel_view_processing=0,
    optimize_trivial_insert_select=0,
    max_insert_threads=5; -- { serverError FUNCTION_THROW_IF_VALUE_IS_NON_ZERO }
system flush logs;
select peak_threads_usage from system.query_log where
    current_database = currentDatabase() and
    type != 'QueryStart' and
    query like '%insert into testX %' and
    Settings['parallel_view_processing'] = '0' and
    Settings['optimize_trivial_insert_select'] = '0' and
    Settings['max_insert_threads'] = '5';
2
select count() from testX;
400
select count() from testXA;
400
select count() from testXB;
0
select count() from testXC;
400
select 'optimize_trivial_insert_select=1', 'max_insert_threads=0';
optimize_trivial_insert_select=1	max_insert_threads=0
insert into testX select number from numbers(200) settings
    log_queries=1,
    parallel_view_processing=0,
    optimize_trivial_insert_select=1,
    max_insert_threads=0; -- { serverError FUNCTION_THROW_IF_VALUE_IS_NON_ZERO }
system flush logs;
select peak_threads_usage from system.query_log where
    current_database = currentDatabase() and
    type != 'QueryStart' and
    query like '%insert into testX %' and
    Settings['parallel_view_processing'] = '0' and
    Settings['optimize_trivial_insert_select'] = '1' and
    Settings['max_insert_threads'] = '0';
2
select count() from testX;
600
select count() from testXA;
600
select count() from testXB;
0
select count() from testXC;
600
select 'optimize_trivial_insert_select=1', 'max_insert_threads=5';
optimize_trivial_insert_select=1	max_insert_threads=5
insert into testX select number from numbers(200) settings
    log_queries=1,
    parallel_view_processing=0,
    optimize_trivial_insert_select=1,
    max_insert_threads=5; -- { serverError FUNCTION_THROW_IF_VALUE_IS_NON_ZERO }
system flush logs;
select peak_threads_usage from system.query_log where
    current_database = currentDatabase() and
    type != 'QueryStart' and
    query like '%insert into testX %' and
    Settings['parallel_view_processing'] = '0' and
    Settings['optimize_trivial_insert_select'] = '1' and
    Settings['max_insert_threads'] = '5';
2
select count() from testX;
800
select count() from testXA;
800
select count() from testXB;
0
select count() from testXC;
800
select 'optimize_trivial_insert_select=0', 'max_insert_threads=0';
optimize_trivial_insert_select=0	max_insert_threads=0
insert into testX select number from numbers(200) settings
    log_queries=1,
    parallel_view_processing=1,
    optimize_trivial_insert_select=0,
    max_insert_threads=0; -- { serverError FUNCTION_THROW_IF_VALUE_IS_NON_ZERO }
system flush logs;
select peak_threads_usage from system.query_log where
    current_database = currentDatabase() and
    type != 'QueryStart' and
    query like '%insert into testX %' and
    Settings['parallel_view_processing'] = '1' and
    Settings['optimize_trivial_insert_select'] = '0' and
    Settings['max_insert_threads'] = '0';
5
select count() from testX;
1000
select count() from testXA;
1000
select count() from testXB;
0
select count() from testXC;
1000
select 'optimize_trivial_insert_select=0', 'max_insert_threads=5';
optimize_trivial_insert_select=0	max_insert_threads=5
insert into testX select number from numbers(200) settings
    log_queries=1,
    parallel_view_processing=1,
    optimize_trivial_insert_select=0,
    max_insert_threads=5; -- { serverError FUNCTION_THROW_IF_VALUE_IS_NON_ZERO }
system flush logs;
select peak_threads_usage from system.query_log where
    current_database = currentDatabase() and
    type != 'QueryStart' and
    query like '%insert into testX %' and
    Settings['parallel_view_processing'] = '1' and
    Settings['optimize_trivial_insert_select'] = '0' and
    Settings['max_insert_threads'] = '5';
12
select count() from testX;
1190
select count() from testXA;
1130
select count() from testXB;
60
select count() from testXC;
1130
select 'optimize_trivial_insert_select=1', 'max_insert_threads=0';
optimize_trivial_insert_select=1	max_insert_threads=0
insert into testX select number from numbers(200) settings
    log_queries=1,
    parallel_view_processing=1,
    optimize_trivial_insert_select=1,
    max_insert_threads=0; -- { serverError FUNCTION_THROW_IF_VALUE_IS_NON_ZERO }
system flush logs;
select peak_threads_usage from system.query_log where
    current_database = currentDatabase() and
    type != 'QueryStart' and
    query like '%insert into testX %' and
    Settings['parallel_view_processing'] = '1' and
    Settings['optimize_trivial_insert_select'] = '1' and
    Settings['max_insert_threads'] = '0';
2
select count() from testX;
1390
select count() from testXA;
1330
select count() from testXB;
60
select count() from testXC;
1330
select 'optimize_trivial_insert_select=1', 'max_insert_threads=5';
optimize_trivial_insert_select=1	max_insert_threads=5
insert into testX select number from numbers(200) settings
    log_queries=1,
    parallel_view_processing=1,
    optimize_trivial_insert_select=1,
    max_insert_threads=5; -- { serverError FUNCTION_THROW_IF_VALUE_IS_NON_ZERO }
system flush logs;
select peak_threads_usage from system.query_log where
    current_database = currentDatabase() and
    type != 'QueryStart' and
    query like '%insert into testX %' and
    Settings['parallel_view_processing'] = '1' and
    Settings['optimize_trivial_insert_select'] = '1' and
    Settings['max_insert_threads'] = '5';
7
select count() from testX;
1590
select count() from testXA;
1480
select count() from testXB;
160
select count() from testXC;
1490
